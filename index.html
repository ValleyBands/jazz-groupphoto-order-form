<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Band Group Photo Order Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for longer forms */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px; /* Wider for more fields */
            text-align: left; /* Align text left for form fields */
            margin-top: 20px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151; /* Darker gray for labels */
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        /* Added select to apply base styling */
        select { 
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 8px;
            margin-bottom: 16px;
            box-sizing: border-box;
            font-size: 1rem;
            color: #1f2937; /* Dark text */
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
             border-color: #4f46e5; /* Highlight on focus */
             outline: none;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .student-entry {
            border: 1px dashed #a5b4fc; /* Light indigo dashed border */
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            background-color: #f5f6ff; /* Very light blue */
        }
        .remove-student-btn {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 8px;
            transition: background-color 0.2s ease;
        }
        .remove-student-btn:hover {
            background-color: #dc2626; /* Darker red */
        }
        .add-student-btn {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 16px;
            margin-bottom: 24px;
            transition: background-color 0.2s ease;
        }
        .add-student-btn:hover {
            background-color: #4338ca; /* Darker indigo */
        }
        button[type="submit"] {
            background-color: #22c55e; /* Green */
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button[type="submit"]:hover {
            background-color: #16a34a; /* Darker green */
            transform: translateY(-1px);
        }
        .message-box {
            background-color: #d1fae5; /* Light green for success */
            color: #065f46; /* Dark green text */
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            text-align: center;
            display: none; /* Hidden by default */
        }
        .message-box.error {
            background-color: #fee2e2; /* Light red for error */
            color: #991b1b; /* Dark red text */
        }
        .payment-link-section {
            margin-top: 16px;
            text-align: center;
        }
        .payment-link-section a {
            color: #4f46e5;
            text-decoration: underline;
        }
        .payment-link-section a:hover {
            color: #4338ca;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Jazz Band Group Photo Order Form</h1>
        <p class="text-gray-600 mb-8 text-center">Each Group Photo costs <span class="font-semibold text-indigo-600">$15.45</span>. Data will be submitted to the Google Sheet.</p>

            <div class="mb-8 text-center">
              <h2 class="text-xl font-semibold text-gray-800 mb-4">Group Photo Example:</h2>
              <img
                src="https://raw.githubusercontent.com/ValleyBands/jazz-groupphoto-order-form/main/Basie%20Band_2.png"
                alt="Example band group photo"
                class="mx-auto rounded-lg shadow-lg border-4 border-indigo-300 w-72 h-48 object-cover"
                onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/000000?text=Band+Group+Photo';"
              >
              <p class="text-sm text-gray-500 mt-2">Example Band Group Photo</p>
            </div>


        <form id="bandOrderForm" class="space-y-4">
            <div>
                <label for="parentName">Parent/Guardian Name:</label>
                <input type="text" id="parentName" name="parentName" required>
            </div>

            <div>
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>

            <div>
                <label for="phone">Phone Number:</label>
                <input type="tel" id="phone" name="phone" oninput="formatPhoneNumber(this)" maxlength="12" placeholder="e.g., 123-456-7890" required>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4 border-b pb-2">Student Information</h2>
            <div id="studentsContainer">
                <div class="student-entry" data-student-id="1">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Student 1</h3>
                    <label for="studentName_1">Student Name:</label>
                    <input type="text" id="studentName_1" name="studentName_1" required>

                    <label for="jazzBand_1">Jazz Band:</label>
                    <select id="jazzBand_1" name="jazzBand_1" required>
                        <option value="" disabled selected>Select Band</option>
                        <option value="Basie band">Basie band</option>
                        <option value="Ellington band">Ellington band</option>
                        <option value="Jazz Orchestra">Jazz Orchestra</option>
                        <option value="Jazz Ensemble">Jazz Ensemble</option>
                        <option value="Studio Jazz">Studio Jazz</option>
                    </select>

                    <label for="numphotos_1">Number of Group Photos for Student 1:</label>
                    <input type="number" id="numphotos_1" name="numphotos_1" min="0" value="0" oninput="calculateTotal()" required>
                </div>
            </div>

            <button type="button" id="addStudentBtn" class="add-student-btn">Add Another Student</button>

            <div class="bg-indigo-100 p-6 rounded-lg border-2 border-indigo-300 mt-8">
                <p class="text-xl text-indigo-800 font-semibold mb-2 text-center">Total Cost for All Group Photos:</p>
                <p id="totalCost" class="text-5xl font-extrabold text-indigo-700 text-center">$0.00</p>
                <input type="hidden" id="hiddenTotalCost" name="totalCost" value="0.00">
            </div>

            <button type="submit" class="mt-8">Submit Order and Pay Here</button>
        </form>

        <div class="payment-link-section">
            <p class="text-gray-600">If re-direct to payment site doesn't work please use this link: <a href="https://checkout.square.site/merchant/44QXX4R2B839B/checkout/AWBE6FFXZQALGDPUHMAAC46C" target="_blank">Payment Link</a></p>
        </div>
        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
        // Define the price per photo
        const PRICE_PER_PHOTO = 15.45;
        let studentCounter = 1;

        // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        // !!! IMPORTANT: MAKE SURE THIS URL IS CORRECT AND POINTS TO YOUR LATEST DEPLOYMENT (Who has access: Anyone)
        // !!! Your previously provided SCRIPT_URL:
        // 'https://script.google.com/macros/s/AKfycbxCH2qAky8y-ZibI22LOlgOEdF1U07Iit-d-HSfNHkTLlBMb1vPfi8Env1xGGlkjlKBNQ/exec'
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPUwE2ZrGvZtMa2qsNEXByYta7FmvIaBFaYa-nevyf16nGcNrthsplLEyyLjE4GpS9/exec'; 
        // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
        
        const BASE_PAYMENT_REDIRECT_URL = 'https://checkout.square.site/merchant/44QXX4R2B839B/checkout/MZPG4FERMHY4P5LDQ5HCVFZ2';

        /**
         * Automatically formats a phone number as ###-###-#### as the user types.
         * @param {HTMLElement} input - The input field element.
         */
        function formatPhoneNumber(input) {
            let numbers = input.value.replace(/\D/g, '');
            let formattedNumber = '';

            if (numbers.length > 0) {
                formattedNumber += numbers.substring(0, 3);
            }
            if (numbers.length >= 4) {
                formattedNumber += '-' + numbers.substring(3, 6);
            }
            if (numbers.length >= 7) {
                formattedNumber += '-' + numbers.substring(6, 10);
            }

            input.value = formattedNumber;
        }

        /**
         * Calculates the total cost based on the number of photos for all students.
         */
        function calculateTotal() {
            let overallTotal = 0;
            const numPhotosInputs = document.querySelectorAll('input[name^="numPhotos_"]');

            numPhotosInputs.forEach(input => {
                const numberOfPhotos = parseInt(input.value) || 0;
                if (numberOfPhotos < 0) {
                    input.value = 0; 
                }
                overallTotal += (parseInt(input.value) || 0) * PRICE_PER_PHOTO;
            });

            document.getElementById('totalCost').textContent = `$${overallTotal.toFixed(2)}`;
            document.getElementById('hiddenTotalCost').value = overallTotal.toFixed(2);
        }

        /**
         * Adds a new student entry section to the form.
         */
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            studentCounter++;
            const studentsContainer = document.getElementById('studentsContainer');
            const newStudentEntry = document.createElement('div');
            newStudentEntry.classList.add('student-entry');
            newStudentEntry.setAttribute('data-student-id', studentCounter);

            newStudentEntry.innerHTML = `
                <h3 class="text-lg font-medium text-gray-700 mb-2">Student ${studentCounter}</h3>
                <label for="studentName_${studentCounter}">Student Name:</label>
                <input type="text" id="studentName_${studentCounter}" name="studentName_${studentCounter}" required>

                <label for="jazzBand_${studentCounter}">Jazz Band:</label>
                <select id="jazzBand_${studentCounter}" name="jazzBand_${studentCounter}" required>
                    <option value="" disabled selected>Select Band</option>
                    <option value="Basie band">Basie band</option>
                    <option value="Ellington band">Ellington band</option>
                    <option value="Jazz Orchestra">Jazz Orchestra</option>
                    <option value="Jazz Ensemble">Jazz Ensemble</option>
                    <option value="Studio Jazz">Studio Jazz</option>
                </select>

                <label for="numPhotos_${studentCounter}">Number of Group Photos for Student ${studentCounter}:</label>
                <input type="number" id="numPhotos_${studentCounter}" name="numPhotos_${studentCounter}" min="0" value="0" oninput="calculateTotal()" required>

                <button type="button" class="remove-student-btn" onclick="removeStudent(this)">Remove Student</button>
            `;
            studentsContainer.appendChild(newStudentEntry);
            calculateTotal(); // Recalculate total after adding new student
        });

        /**
         * Removes a student entry section from the form.
         * @param {HTMLElement} button - The remove button clicked.
         */
        function removeStudent(button) {
            const studentEntry = button.closest('.student-entry');
            if (studentEntry) {
                studentEntry.remove();
                calculateTotal(); // Recalculate total after removing student
            }
        }

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false for success.
         */
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            messageBox.classList.toggle('error', isError);
            // Hide message after 3 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        /**
         * Resets the student entry section to the default single student.
         */
        function resetStudentEntries() {
            document.getElementById('studentsContainer').innerHTML = `
                <div class="student-entry" data-student-id="1">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Student 1</h3>
                    <label for="studentName_1">Student Name:</label>
                    <input type="text" id="studentName_1" name="studentName_1" required>

                    <label for="jazzBand_1">Jazz Band:</label>
                    <select id="jazzBand_1" name="jazzBand_1" required>
                        <option value="" disabled selected>Select Band</option>
                        <option value="Basie band">Basie band</option>
                        <option value="Ellington band">Ellington band</option>
                        <option value="Jazz Orchestra">Jazz Orchestra</option>
                        <option value="Jazz Ensemble">Jazz Ensemble</option>
                        <option value="Studio Jazz">Studio Jazz</option>
                    </select>

                    <label for="numphotos_1">Number of Group Photos for Student 1:</label>
                    <input type="number" id="numphotos_1" name="numphotos_1" min="0" value="0" oninput="calculateTotal()" required>
                </div>
            `;
            studentCounter = 1; // Reset counter
            calculateTotal(); // Recalculate total after reset
        }


        // Handle form submission
        document.getElementById('bandOrderForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const phoneInput = document.getElementById('phone');
            const phoneNumber = phoneInput.value.replace(/\D/g, '');
            if (phoneNumber.length !== 10) {
                showMessage('Please enter a valid 10-digit phone number.', true);
                phoneInput.focus();
                return; // Stop submission
            }

            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            const students = [];
            let isValid = true; // Flag to track student validation

            // Manually collect student data and perform validation
            document.querySelectorAll('.student-entry').forEach((entry, index) => {
                if (!isValid) return; // Stop if previous student validation failed
                
                const studentId = entry.getAttribute('data-student-id');
                const studentNameInput = document.getElementById(`studentName_${studentId}`);
                const jazzBandInput = document.getElementById(`jazzBand_${studentId}`);
                const numButtonsInput = document.getElementById(`numPhotos_${studentId}`);

                // Client-side validation for student fields
                if (!studentNameInput.value.trim()) {
                    showMessage('Student name cannot be empty.', true);
                    studentNameInput.focus();
                    isValid = false; return;
                }
                // Check the select value directly
                if (!jazzBandInput.value.trim()) {
                    showMessage('Please select a Jazz Band.', true);
                    jazzBandInput.focus();
                    isValid = false; return;
                }
                if (parseInt(numButtonsInput.value) <= 0) {
                    showMessage('Number of buttons for each student must be greater than 0.', true);
                    numButtonsInput.focus();
                    isValid = false; return;
                }

                students.push({
                    name: studentNameInput.value,
                    jazzBand: jazzBandInput.value,
                    numButtons: numButtonsInput.value
                });
            });

            if (!isValid) return; // Stop submission if student validation failed

            // Collect other general form data
            for (let [key, value] of formData.entries()) {
                // Skip the individual student fields which are handled by the 'students' array
                if (!key.startsWith('studentName_') && !key.startsWith('jazzBand_') && !key.startsWith('numPhotos_')) {
                    data[key] = value;
                }
            }
            
            // Add the structured students data (as a JSON string)
            data['students'] = JSON.stringify(students);

            const currentTotal = parseFloat(document.getElementById('hiddenTotalCost').value);
            if (currentTotal <= 0) {
                showMessage('Total number of buttons must be greater than $0.00.', true);
                return;
            }

            // --- DEBUGGING: LOG THE PAYLOAD BEFORE SUBMISSION ---
            console.log('--- Submitting Data Payload ---');
            console.log('Structured Data:', data);
            
            const payload = new URLSearchParams(data).toString();
            console.log('URL Encoded Payload:', payload);
            console.log('-----------------------------');
            // ----------------------------------------------------


            try {
                // Use exponential backoff for API call reliability
                let response;
                let success = false;
                const maxRetries = 3;
                let delay = 1000; // 1 second starting delay

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            // Send the data object converted to URL search parameters
                            body: payload // Use the pre-calculated payload
                        });
                        // Since mode is 'no-cors', we assume success if the fetch call doesn't throw a network error.
                        success = true;
                        break; 
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed:`, error);
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                        } else {
                            throw new Error('Failed to submit form after multiple retries.');
                        }
                    }
                }

                if (success) {
                    // Success message updated to reflect the imminent redirect
                    showMessage('Order data successfully submitted. Email confirmation sent. Opening payment link in new window in 3 seconds...', false);
                    form.reset();
                    resetStudentEntries(); // Reset dynamic form state

                    // >>> PAYMENT REDIRECT RE-ENABLED TO OPEN IN A NEW WINDOW <<<
                    setTimeout(() => {
                        window.open(BASE_PAYMENT_REDIRECT_URL, '_blank');
                    }, 3000); // Redirect after 3 seconds
                }

            } catch (error) {
                console.error('Error submitting form:', error);
                showMessage('There was an error submitting your order. Please check the console for details.', true);
            }
        });

        // Initialize total calculation on page load
        window.onload = calculateTotal;
    </script>
</body>
</html>
